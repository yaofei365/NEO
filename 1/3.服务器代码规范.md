## 服务器代码规范
#### 1. 提交`SVN`提交时的注释规范     
```lua
2.3.1.0|BUG #32653::【2.3.1.0】【竞技场】服务器卡时多次点击重置有误
```
说明:     
(1) `2.3.1.0` 为版本号    
(2) `|`后面为具体的禅道`BUG Id`或具体的修改内容      
(3) 错误示例:  `2.3.1.0|抽卡：bug fixed`, 原因: 没有写清楚具体的修改内容      
(4) 正确示例:  `2.3.1.0|BUG #32653::【0.3.0.11197测试】【竞技场】服务器卡时多次点击重置有误`

#### 2.函数注释规范, 统一采用以下格式        
```lua
--[[
-- 注释内容
--]]
```

#### 3.所有代码使用的结构, 必须在 `\deploy\common\netimpl\common\` 目录下有定义; 如果在一个 `lua` 文件内使用一个`结构`(注意: 这个结构只有这个文件才使用到), 那么必须注释说明这个`结构`的内容    
```lua
-- 下面注意很清晰看到 tbl_cache 这个 table 中, activity_type 作为 key, 
-- value 存放着一个结构, 结构里包含这两个字段, 分别是 activity_id 和 activity_name 
tbl_cache = {} -- = { [activity_type] = {{activity_id = xx, activity_name = xx}, ...} }
```

#### 4.所有Log必须有`模块名`, `方法名`, 并尽量加上 `player_id`, 方便具体玩家问题的定位      
```lua
-- 示例
-- gw_task_oper 表示模块名
-- submit 表示模块方法名
-- player_id, task_id 相关参数
-- cant found task id 为具体的错误信息
log_error("gw_task_oper|submit|player_id(%d)|task_id(%d)|cant found task id", player_id, task_id)
```

#### 5.不要在服务器代码中返回文字给客户端      
(1) 错误信息必须通过`错误码`通知客户端       
(2) `公告`, `系统邮件` 内容统一由策划配置在 `server_language_cn` 配置表中      
(3) `server_language_cn` 中一条记录包含 `lang_type`, `lang_id` 和 `lang_str` 三个字段      
(4) `lang_type` 表示模块名, `lang_id` 表示模块内标识, `lang_str` 表示具体的文字信息    
(5) `server_language_cn` 配置表的内容统一通过 `language_mgr` 来访问     
```
local language_mgr = require("server_common.language_mgr")
local mail_subject = language_mgr:fmt_lang("ACTIVITY_CLOUD_BUY", "MAIL_SUBJECT")
```

#### 6.除了枚举/全局变量, 其它变量一律小写下划线分隔形式     
注: 常量的定义,及引入常量的变量大写     
```lua
-- 正确示例
local retcode = ERRCODE.GWERR_NO_GOLD

-- 错误示例
local retcode = errcode.GWERR_NO_GOLD
```

#### 7. 如果需要在多于一个 `lua` 文件中传递一个 `结构`, 那么这个 `结构` 需要定义    
注:      
(1) 在 `deploy\common\netimpl\common\` 目录下增加对应的`结构`定义文件
(2) 按以下格式写结构
```lua
local network = require("network")

local function response_serial(self, buffer)
	network.writenumber(buffer, self.activity_id)
	network.writenumber(buffer, self.player_id)
end

local function response_unserial(self, buffer)
	self.activity_id = network.readnumber(buffer)
	self.player_id = network.readnumber(buffer)
end

local protocol = {}
function protocol.create_request()
	error("not implemented")
end

function protocol.create_response()
	local response = {}
	response.activity_id = 0 -- 活动 id
	response.player_id = 0 -- 玩家 id

	response.serial = response_serial
	response.unserial = response_unserial
	return response
end

return protocol
```     
错误示例:     
```
function protocol.create_response()
	local response = {
		activity_id = 0,
		player_id = 0,
		serial = response_serial,
		unserial = response_unserial,
	}

	return response
end
```

#### 8. 如果一个`table`是一个`序列`或`hash table`, 变量命令必须以`tbl_` 开头
```lua
-- 示例
-- local tbl_player = {}
```

#### 9. 变量名禁用 `..` 字符串连接用法
```lua
-- 错误示例
USE_TYPE = {
  [1] = 'GOLD',
  [2] = 'DIAMOND',
  [3] = 'STAMINA',
  [4] = 'ITEM',
  [5] = 'SOUL',
  [6] = 'GUILD_CONTRIBUTE',
}
resp.retcode = ERRCODE['GWERR_NO_' .. USE_TYPE[cost_type]]

-- 正确示例
resp.retcode = ERRCODE.GWERR_NO_SOUL
```

#### 10. Lua中字符串允许用单引号或双引号括起来, 服务器统一用双引号       
```lua
-- 错误示例
log_debug('test')

-- 正确示例
log_debug("test")
```

#### 11. 在业务逻辑的代码中不要使用协程

#### 12. 尽量避免在循环体内调用`syncCall`, `syncSend`

#### 13. 服务器与客户端统一采用`load_table`接口来读取静态表     
```lua
-- 配置表文件 equip 通过 load_table("tb_table_equip") 来访问, 注意: 需要加上 tb_table_ 前缀
local tb_table_equip = load_table("tb_table_equip")
```

#### 14. 玩家登录不需要立即显示的内容不要在`gw_player_online`这条协议返回, 尽量做成打开界面请求的形式       
注: `gw_player_online` 协议为客户端登录`gateway`成功后, 第一条返回给客户端的协议    

#### 15. 具体的业务逻辑尽量不要放在`dbmgr`和`loginmgr`两个进程      

#### 16. 协议`Lua`文件用进程名缩写两个字母开头, 但协议公用结构的`Lua`文件则不需要          

#### 17. 下列函数，除了在`main.lua`里，其它文件不需要`require`，可以直接使用       
```lua
        _ENV.log_info = log_info
        _ENV.log_debug = log_debug
        _ENV.log_warning = log_warning
        _ENV.log_error = log_error
        _ENV.log_file = log_file
        _ENV.NETDEFINE = NETDEFINE
        _ENV.daserver = daserver
        _ENV.create_impl = create_impl
        _ENV.ERRCODE = ERRCODE
        _ENV.UPDATEDEFINE = UPDATEDEFINE
        _ENV.ITEM_OPER_TYPE = ITEM_OPER_TYPE
        _ENV.MONEY_OPER_TYPE = MONEY_OPER_TYPE
        _ENV.load_table = load_table
```

